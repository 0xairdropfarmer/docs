# NuLink Worker Update

The NuLink worker node need to be updated when a new version is released. The update procedure could be different for the docker environment and local environment.


## Update in docker environment

### Staking account and worker account is available

If the staking account and keystore file of the worker account is still available, then the update procedure is pretty trivial. Simply stop the node, pull the latest image and restart the node.

1. Stop the running node in Docker  
    ```shell
    $ docker kill <container ID>
    ```

2. Pull the latest NuLink image.  
    ```shell
    $ docker pull nulink/nulink:latest
    ```

3.  Re-launch the worker node.  
    ```shell
    $ docker run --restart on-failure -d \
    --name ursula \
    -p 9151:9151 \
    -v /root/nulink:/code \
    -v /root/nulink:/home/circleci/.local/share/nulink \
    -e NULINK_KEYSTORE_PASSWORD \
    -e NULINK_OPERATOR_ETH_PASSWORD \
    nulink/nulink nulink ursula run --no-block-until-ready
    ```

### Staking account or worker account is lost

If the staking account or the worker account is lost(this means either you can not login your staking account in Metamask or your keystore file in host directory is deleted), then the update procedure is a little bit complex. Here is the suggest way.

1.  Stop and remove the running node in Docker  
     ```shell
    $ docker kill <container ID>

    $ docker rm <container ID>
     ```

2.  Pull the latest NuLink image.  
    ```shell
    $ docker pull nulink/nulink:latest
    ```

3.  Delete the old host directory and create a new host directory.  
    ```shell
    $ cd /root
    
    $ rm -rf nulink

    $ mkdir nulink
    ```

4.  Copy the keystore file of the Worker account to the host directory selected in step 3(if you lost the old worker account, you could generate a new one and copy the keystore file of the new worker account here). **Please ensure that this directory has 777 permissions**:  
    ```shell
    $ cp /root/geth-linux-amd64-1.10.23-d901d853/keystore/UTC--2022-09-13T01-14-32.465358210Z--8b1819341bec211a45a2186c4d0030681ccce0ee /root/nulink

    $ chmod -R 777 /root/nulink
    ```
5. Export Node Environment Variables:   
    ```shell
    # Password used for lock/unlock the private storage generated by NuLink Worker.You can choose some characters(8 minimum) as the password here. Do not forget it!!!
    $ export NULINK_KEYSTORE_PASSWORD=<YOUR NULINK STOREAGE PASSWORD>

    # Password used to unlock the keystore file of Worker account, you should have set it up when you create the Worker account using Geth or other sources. Make sure you enter the same one!!!
    $ export NULINK_OPERATOR_ETH_PASSWORD=<YOUR WORKER ACCOUNT PASSWORD>
    ```


6. Since the staking account is lost, the old URI is always bonded and can not be unbonded. Need to change another port(say 9152) to initialize Node Configuration:    

    ```shell
    $ docker run -it --rm \
    -p 9152:9152  \
    -v /root/nulink:/code \
    -v /root/nulink:/home/circleci/.local/share/nulink \
    -e NULINK_KEYSTORE_PASSWORD \
    nulink/nulink nulink ursula init \
    --signer keystore:///code/UTC--2022-09-13T01-14-32.465358210Z--8b1819341bec211a45a2186c4d0030681ccce0ee \
    --eth-provider https://data-seed-prebsc-2-s2.binance.org:8545 \
    --network horus \
    --payment-provider https://data-seed-prebsc-2-s2.binance.org:8545 \
    --payment-network bsc_testnet \
    --operator-address 0x8B1819341BEc211a45a2186C4D0030681cccE0Ee \
    --max-gas-price 100
    ```

7. Launch the Node using the new configuration:   

    ```shell
    $ docker run --restart on-failure -d \
    --name ursula \
    -p 9152:9152 \
    -v /root/nulink:/code \
    -v /root/nulink:/home/circleci/.local/share/nulink \
    -e NULINK_KEYSTORE_PASSWORD \
    -e NULINK_OPERATOR_ETH_PASSWORD \
    nulink/nulink nulink ursula run \
    --rest-port 9152 \
    --config-file /home/circleci/.local/share/nulink/ursula.json  \
    --no-block-until-ready
    ```

8. Check the node running status and bond the new worker account to new staking account in [Dapp](https://test-staking.nulink.org/).  

## Update in local environment

### Staking account and worker account is available

If the staking account and keystore file of the worker account is still available, then the update procedure is pretty trivial.

1. Access to your virtual environment  
   ```shell
   source /root/nulink-venv/bin/activate
   (nulink-venv) root@iZt4niz7s1ss0908w31u5pZ:~#    
   ```

2. Stop the running node   
   ```shell
   screen -x nulink-worker // use this command if you run the worker node in a screen session

   press ctrl+c
   ```

3. Uninstall the old package and install the new package   
   ```shell
   pip uninstall nulink-0.1.0-py3-none-any.whl // make sure the package name matches your installed package

   (nulink-venv) root@iZt4niz7s1ss0908w31u5pZ:~# wget https://download.nulink.org/release/core/nulink-0.2.0-py3-none-any.whl
      
   (nulink-venv) root@iZt4niz7s1ss0908w31u5pZ:~# pip install nulink-0.2.0-py3-none-any.whl
   ```

4.   Verify Installation use the same command when install the first time.  Check [Here](https://docs.nulink.org/products/nulink_worker/worker_install#local-install) 

5.  Launch the node use the same config file  
   ```shell
   screen -S nulink-worker // use this command if you want to run the worker node in a screen session

   nulink ursula run --no-block-until-ready
   ```

### Staking account or worker account is lost

If the staking account or the worker account is lost(this means either you can not login your staking account in Metamask or your keystore file in host directory is deleted), then the update procedure is a little bit complex. Here is the suggest way.

1. Access to your virtual environment  
   ```shell
   source /root/nulink-venv/bin/activate
   (nulink-venv) root@iZt4niz7s1ss0908w31u5pZ:~#    
   ```

2. Stop the running node   
   ```shell
   screen -x nulink-worker // use this command if you run the worker node in a screen session

   press ctrl+c
   ```

3. Uninstall the old package and install the new package   
   ```shell
   pip uninstall nulink-0.1.0-py3-none-any.whl // make sure the package name matches your installed package

   (nulink-venv) root@iZt4niz7s1ss0908w31u5pZ:~# wget https://download.nulink.org/release/core/nulink-0.2.0-py3-none-any.whl
      
   (nulink-venv) root@iZt4niz7s1ss0908w31u5pZ:~# pip install nulink-0.2.0-py3-none-any.whl
   ```

4.   Verify Installation use the same command when install the first time.  Check [Here](https://docs.nulink.org/products/nulink_worker/worker_install#local-install) 


5.  Initialize node with new configuration, remember to copy the keystore file of your new worker account to the keystore directory and replace the operator address to your new worker address.   

   ```shell
   nulink ursula init \
   --signer keystore:///root/nulink/keystore \
   --eth-provider https://data-seed-prebsc-2-s2.binance.org:8545 \
   --network horus \
   --payment-provider https://data-seed-prebsc-2-s2.binance.org:8545 \
   --payment-network bsc_testnet \
   --operator-address 0x8a20d379A4C08c482a617A81a39EB426B6EB8642 \
   --max-gas-price 2000
   ```
   
6.  Launch the node use the same config file   
   ```shell
   screen -S nulink-worker // use this command if you want to run the worker node in a screen session

   nulink ursula run --rest-port 9152 --no-block-until-ready
   ```
7.  Check the node running status and bond the new worker account to new staking account in [Dapp](https://test-staking.nulink.org/).  